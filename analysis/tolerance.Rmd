---
title: "Thermal tolerance analysis"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(readxl)
library(janitor)
library(parzer)
library(broom)
library(lsmeans)
library(drc)
library(tidyverse)
library(ggthemes)
library(multcompView)
```

This document analyzes the ED50 values (thermal tolerance metrics) derived for each individual coral genotype. Data filtering, dose-response curve fitting, and calculation of ED50 values for each coral can be found [here](tidy_PAM.html), and raw data from each CBASS run can be found here: [Mote](Mote_Acer.html), [FWC](FWC_Acer.html), [RRT](RRT_Acer.html), [CRF](CRF_Acer.html), [UM](UM_Acer.html), and [Kelsey's corals at NSU](KJS_Acer.html).


```{r import_data}
# Import cleaned datasets from each nursery
clean_data_files <- list.files(path = "data/processed", 
                               pattern = "*_clean.csv", 
                               full.names = TRUE)
clean_data <- clean_data_files %>% map_dfr(read_csv)

# Import genotype metadata
gmd <- read_csv("data/genotype_metadata_raw.csv") %>%
  mutate(nursery = tolower(nursery),
         across(everything(), str_squish),
         across(ends_with("lat"), ~signif(parse_lat(.), 6)),             # parse latitude
         across(ends_with("lon"), ~signif(parse_lon(.), 6))) %>%        # parse longitude
  mutate(ugeno = gsub(" ", "", ugeno)) %>%
  select(nursery, name = geno, source_lat, source_lon, MMM_5km)

# Import names key
gkey <- read_csv("data/genotype_name_key.csv") %>%
  mutate(alt0 = geno) %>%
  pivot_longer(starts_with("alt"), names_to = "alt", values_to = "name") %>%
  drop_na() %>%
  select(geno, name)

# Combine cleaned data with genotype metadata
df <- clean_data %>%
  rename(name = geno) %>%
  left_join(gkey) %>%
  select(nursery, geno, name, max_temp, fvfm, date) %>%
  left_join(gmd) %>%
  # Order nurseries from south to north
  mutate(nursery = factor(nursery, levels = c("mote", "fwc", "rrt", "crf", "um", "nsu"))) %>%
  select(nursery, name, geno, date, max_temp, fvfm, source_lat, source_lon, MMM_5km)

# Define dose-response curves using same constraints
ll3 <- function(data) {
  drm(fvfm ~ max_temp, data = data, 
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))}

# Fit model to each coral, get parameters, fitted values, and residuals
mods <- df %>%
  nest(data = c(max_temp, fvfm)) %>%
  # Fit the model to each coral
  mutate(ll3 = map(data, ll3)) %>%
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy),
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract parameter values from model fits
res <- mods %>% 
  select(nursery, geno, name, date, pars) %>%
  unnest(pars) %>%
  select(-curve) %>%
  pivot_wider(id_cols = c(nursery, geno, name, date), 
              names_from = term, 
              values_from = c(estimate, std.error, statistic, p.value)) %>%
  clean_names()

# Filter to analyze only CBASS runs from Coral Reef II in August and October
res <- res %>%
  filter(date %in% c("2020-08", "2020-10"))
```

# Do different genotypes have different thermal tolerance?

```{r test_geno_effect, eval = FALSE, include = FALSE}
# Fit single curve without genotype as a factor
mod_nogeno <- drm(fvfm ~ max_temp, data = df, 
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))
# Fit curves separately for each genotype
mod_geno <- drm(fvfm ~ max_temp, curveid = geno, data = df,
                fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))
# Compare model fit with vs. without genotype as factor
anova(mod_nogeno, mod_geno)

## Genotype is highly significant
```

# What is the range in thermal tolerance across all genotypes?

```{r ed50_histograms}
# Basic histogram
ggplot(res, aes(x = estimate_ed50)) + 
  geom_histogram(binwidth = 0.1) +
  labs(x = "ED50 Tolerance (°C)", y = "Number of genotypes",
       title = "Histogram of ED50 values for all corals")

# Histogram colored by nursery with density plot
hist1 <- res %>%
  mutate(nursery = factor(nursery, levels = c("fwc", "um", "mote", "crf", "nsu", "rrt"))) %>%
  ggplot(aes(x = estimate_ed50)) + 
  geom_histogram(aes(fill = nursery), binwidth = 0.1, alpha = 0.4) +
  geom_density(aes(y = ..count.. * 0.1)) +
  theme_few() +
  theme(legend.position = c(0.15, 0.65), legend.key.size = unit(0.25, "cm")) +
  labs(x = "ED50 (°C)", y = "Count", title = expression(V[P]))
hist1

# Remove nursery effect
mod <- lm(estimate_ed50 ~ nursery, data = res)
res.adj <- augment(mod, data = res) %>%
  mutate(ed50_adj = mean(res$estimate_ed50) + .resid)

# Is adjusted distribution normal?
shapiro.test(res.adj$ed50_adj)

# Get mean and sd from adjusted distribution
meanadj <- mean(res.adj$ed50_adj)
sdadj <- sd(res.adj$ed50_adj)

hist2 <- ggplot(res.adj, aes(x = ed50_adj)) + 
  geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 0.1, alpha = 0.4) +
  stat_function(fun = ~ dnorm(.x, meanadj, sdadj) * 0.1) +
  geom_vline(aes(xintercept = meanadj)) +
  geom_segment(aes(x = meanadj, xend = meanadj + sdadj, 
                   y = dnorm(meanadj + sdadj, meanadj, sdadj) * 0.1,
                   yend = dnorm(meanadj + sdadj, meanadj, sdadj) * 0.1),
               arrow = arrow(length = unit(0.2,"cm"), ends = "both"), lwd = 0.1) +
  xlim(qnorm(c(0.00001, 0.99999), meanadj, sdadj)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  annotate("text", x = meanadj - 0.1, y = 0.125, adj = 1,
           label = paste0("mean = ", round(meanadj, 2))) +
  annotate("text", x = meanadj + sdadj + 0.1, 
           y = dnorm(meanadj + sdadj, meanadj, sdadj) * 0.1, 
           adj = 0, label = paste0("s.d. = ", round(sdadj, 2))) +
  theme_few() +
  labs(x = "ED50 (°C) adjusted", y = "Percentage", title = expression(V[P] - V[E]))
hist2

# Combine histograms into multi-panel figure
fig3 <- cowplot::plot_grid(
  hist1 + xlim(qnorm(c(0.00001, 0.99999), meanadj, sdadj)), 
  hist2, labels = "AUTO")

ggsave("output/fig3.png", width = 172, height = 75, units = "mm")
```

# Does thermal tolerance vary across nurseries?

```{r nursery_effects}
# Test for equal variance across nurseries
car::leveneTest(estimate_ed50 ~ nursery, data = res)
bartlett.test(estimate_ed50 ~ nursery, data = res)
## Unequal variance among nurseries -- cannot use ANOVA

# Get mean and sd by nursery for plotting
nurs.stats <- res %>%
  group_by(nursery) %>%
  summarise(mean = mean(estimate_ed50), sd = sd(estimate_ed50)) %>%
  ungroup() #%>%
  #mutate(group = factor(group))

# Use pairwise wilcox to test for differences in ED50 among nurseries
test <- pairwise.wilcox.test(res$estimate_ed50, res$nursery, p.adjust.method = "BH")
pvals <- tibble(reshape2::melt(test$p.value)) %>% drop_na() %>%
  mutate(Var1 = factor(Var1, levels = levels(fct_reorder(nurs.stats$nursery, nurs.stats$mean)))) %>%
  arrange(Var1)
stats <- setNames(pull(pvals[,3]), paste(pvals$Var1, pvals$Var2, sep = "-")) %>% multcompLetters()
lett <- enframe(stats$monospacedLetters, name = "nursery", value = "group")
nurs.stats <- left_join(nurs.stats, lett)
  
# Variance explained by nursery
tidy(aov(estimate_ed50 ~ nursery, data = res)) %>%
  mutate(pct.var = sumsq / sum(sumsq))

# Raincloud plot
source("https://raw.githubusercontent.com/datavizpyr/data/master/half_flat_violinplot.R")
nurs.fig <- ggplot(res, aes(x = nursery, y = estimate_ed50, fill = nursery, group = nursery)) +
  geom_hline(aes(yintercept = mean(estimate_ed50)), lty = 2, col = "gray") +
  geom_flat_violin(position = position_nudge(x = 0.2, y = 0), 
                   adjust = 1, width = 2, alpha = 0.7, lwd = 0) +
  geom_boxplot(position = position_nudge(x = 0.2, y = 0), width = 0.1,
               outlier.shape = NA, alpha = 1, lwd = 0.25) +
  geom_point(aes(color = nursery), alpha = 0.7,
             position = position_jitter(width = 0.075)) +
  geom_point(data = nurs.stats, aes(x = nursery, y = mean), inherit.aes = FALSE,
             position = position_nudge(x = 0, y = 0), size = 2, pch = 5) +
  geom_errorbar(data = nurs.stats, inherit.aes = FALSE, width = 0, lwd = 0.25,
                aes(x = nursery, y = mean, ymin = mean - sd, ymax = mean + sd),
                position = position_nudge(x = 0, y = 0)) +
  geom_text(data = nurs.stats, aes(y = 37.5, label = group), size = 2) +
  coord_flip() +
  scale_size(range = c(0.5, 3)) +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_few() +
  theme(legend.position = "none") +
  labs(y = "ED50 (°C)", x = "Nursery")
nurs.fig

ggsave("output/fig4.png", width = 120, height = 100, units = "mm")
```

# How does ED50 vary for the same genotype grown at different nurseries?
```{r}
# Subset genotypes present at more than one nursery
multi <- res %>%
  group_by(geno) %>%
  filter(n_distinct(nursery) > 1) %>%
  group_by(geno, nursery) %>%
  summarize(estimate_ed50 = mean(estimate_ed50)) %>%
  ungroup()

# Test for equal variance across genotypes
car::leveneTest(estimate_ed50 ~ geno, data = multi)
bartlett.test(estimate_ed50 ~ geno, data = multi)

# How many genotypes were present at more than one nursery
multi %>%
  count(geno, name = "n_nurs") %>%
  count(n_nurs, name = "n_geno")

# Fit model testing effects of genotype and nursery on ED50
mod <- lm(estimate_ed50 ~ nursery + geno, data = multi)
anova(mod)
car::Anova(mod, type = 3)
table1 <- tidy(car::Anova(mod, type = 3)) %>%
  mutate(pctvar = sumsq / sum(sumsq) * 100)
knitr::kable(table1)

## There is a highly significant effect of nursery, indicating an environmental/acclimation effect. There is also a marginally significant effect of genotype, indicating ED50 also has a fixed genetic component. The marginal significance of genotype may be due to the fact that genotypes were only replicated at two (n=17) or three (n=13) nurseries. Genotype and nursery both explain similar percent of total variance (37.8% and 32.4%, respectively).
```

```{r, eval = FALSE, include = FALSE}
# Visualizations of ED50 values for genotypes at multiple nurseries
### None of these are really effective, but the correlations could be useful as supplemental figure. I think the ANOVA table showing a weak effect of genotype is most effective/efficient for the main text.

# Plot ED50 by genotype
ggplot(multi, aes(x = geno, y = estimate_ed50, color = nursery)) + geom_point() + stat_summary(color = "black", size = 0.5)
ggplot(multi, aes(x = nursery, y = estimate_ed50, color = geno)) + geom_point() + stat_summary(color = "black", size = 0.5)

# Plot correlations of ED50 values for same genotypes across nurseries
library(GGally)
multi %>%
  ungroup() %>%
  select(nursery, geno, estimate_ed50) %>%
  pivot_wider(names_from = nursery, values_from = estimate_ed50, values_fn = mean) %>%
  select(-geno) %>%
  ggpairs()

gatherpairs <- function(data, ..., 
                        xkey = '.xkey', xvalue = '.xvalue',
                        ykey = '.ykey', yvalue = '.yvalue',
                        na.rm = FALSE, convert = FALSE, factor_key = FALSE) {
  vars <- quos(...)
  xkey <- enquo(xkey)
  xvalue <- enquo(xvalue)
  ykey <- enquo(ykey)
  yvalue <- enquo(yvalue)

  data %>% {
    cbind(gather(., key = !!xkey, value = !!xvalue, !!!vars,
                 na.rm = na.rm, convert = convert, factor_key = factor_key),
          select(., !!!vars)) 
  } %>% gather(., key = !!ykey, value = !!yvalue, !!!vars,
               na.rm = na.rm, convert = convert, factor_key = factor_key)
}

multi2 <- multi %>%
  pivot_wider(names_from = nursery, values_from = estimate_ed50) %>%
  gatherpairs(fwc, crf, rrt, mote) %>%
  drop_na()

df3 <- multi2 %>%
  group_by(.xkey, .ykey) %>%
  nest() %>%
  mutate(mod = map(data, ~ deming::deming(.yvalue ~ .xvalue, data = .x)),
         int = map_dbl(mod, ~ coef(.x)[1]),
         slp = map_dbl(mod, ~ coef(.x)[2]))

ggplot(multi2, aes(x = .xvalue, y = .yvalue)) + 
  geom_point() +
  geom_abline(data = df3, aes(intercept = int, slope = slp)) + 
  facet_grid(.ykey ~ .xkey, labeller = label_both)
```

# Adjust ED50 for nursery effect, then look for patterns across nurseries?
```{r}
# Subset genotypes present at more than one nursery
multi.adj <- res.adj %>%
  group_by(geno) %>%
  filter(n_distinct(nursery) > 1) %>%
  #filter(var(ed50_adj) < 0.15) %>%
  group_by(geno, nursery) %>%
  summarize(ed50_adj = mean(ed50_adj)) %>%
  ungroup()

# Test for equal variance across genotypes
car::leveneTest(ed50_adj ~ geno, data = multi.adj)    # significant...
bartlett.test(ed50_adj ~ geno, data = multi.adj)    # not significant...

multi.var <- multi.adj %>%
  group_by(geno) %>%
  summarize(lowvar = var(ed50_adj) < 0.1)

multi.adj.means <- multi.adj %>%
  group_by(geno) %>%
  summarize(mean_ed50_adj = mean(ed50_adj)) %>%
  mutate(geno = fct_reorder(geno, mean_ed50_adj))

multi.adj <- multi.adj %>%
  left_join(multi.var) %>%
  mutate(geno = factor(geno, levels = levels(multi.adj.means$geno)))
  

# Plot ED50 by genotype
ggplot(multi.adj, aes(x = geno, y = ed50_adj, color = nursery)) + geom_point(size = 2) + 
  stat_summary(color = "black", size = 0.5, pch = 1)# +
  #facet_wrap(~lowvar, scales = "free_x")
#ggplot(multi.adj, aes(x = nursery, y = ed50_adj, color = geno, group = geno)) + geom_point() + geom_line()

mod <- lm(ed50_adj ~ geno, data = multi.adj)
hist(residuals(mod))
shapiro.test(residuals(mod))
anova(mod)  # regular anova is not significant
kruskal.test(multi.adj$ed50_adj, multi.adj$geno) # not significant
car::Anova(mod, white.adjust = TRUE)   # white-adjusted (for heteroscedasticity) anova is highly significant
oneway.test(ed50_adj ~ geno, data = multi.adj, var.equal = FALSE)    # SIGNIFICANT EFFECT OF GENO IN WELCH ANOVA


```

# Is thermal tolerance related to source latitude and longitude?
```{r, eval = FALSE, fig.width = 10}
# Combine ED50 data with genotype metadata
res <- res %>%
  left_join(gmd)

# ggplot(res, aes(x = source_lon, y = source_lat, color = estimate_ed50)) +
#   geom_point(alpha = 0.5) +
#   scale_color_gradient(low = "blue", high = "red") +
#   labs(x = "Source Longitude", y = "Source Latitude", color = "ED50 Tolerance (°C)")

mod <- lm(estimate_ed50 ~ source_lat + source_lon + nursery, data = res)
anova(mod)
car::Anova(mod, type = 3)

res %>%
  ggplot(aes(x = source_lat, y = estimate_ed50)) +
  geom_point(size = 0.75) +
  #geom_errorbar(aes(ymin = estimate_ed50 - std_error_ed50, ymax = estimate_ed50 + std_error_ed50), lwd = 0.25) +
  geom_smooth(method = "lm", se = FALSE)

res %>%
  ggplot(aes(x = source_lon, y = estimate_ed50)) +
  geom_point(size = 0.75) +
  #geom_errorbar(aes(ymin = estimate_ed50 - std_error_ed50, ymax = estimate_ed50 + std_error_ed50), lwd = 0.25) +
  geom_smooth(method = "lm", se = FALSE)
```
  
Neither source latitude or longitude is a significant predictor of ED50 values across all corals. 

We can also look at whether there is a latitude effect within each nursery.  
```{r, eval = FALSE}
mod <- lm(ed50 ~ source_lat * nursery, weights = 1/std.error, data = df)
anova(mod)
lstrends(mod, specs = "nursery", var = "source_lat")

res <- augment(mod, left_join(mod$model, df))
ggplot(res, aes(x = source_lat, y = ed50, group = nursery, color = nursery)) +
  geom_point() +
  geom_errorbar(aes(ymin = ed50 - std.error, ymax = ed50 + std.error)) +
  geom_line(aes(y = .fitted)) +
  geom_smooth(se = FALSE, lty = 2, lwd = 0.5) +
  facet_wrap(~nursery, scales = "free") +
  labs(x = "Source Latitude", y = "ED50 Tolerance (°C)",
       title = "ED50 Tolerance vs. source latitude, by nursery")
```

There does not appear to be much if any effect of source latitude. Solid lines are linear regression fits, and dashed lines are loess smooths for each nursery. Note the different latitudinal ranges for each nursery -- below all are plotted together.

```{r, eval = FALSE}
ggplot(res, aes(x = source_lat, y = ed50, group = nursery, color = nursery)) +
  geom_point() +
  geom_errorbar(aes(ymin = ed50 - std.error, ymax = ed50 + std.error)) +
  geom_line(aes(y = .fitted)) +
  labs(x = "Source Latitude", y = "ED50 Tolerance (°C)",
       title = "ED50 Tolerance vs. source latitude, all nurseries")
```

# Temperature data
```{r, eval = FALSE}
sst <- tibble(
  filename = list.files("data/sst_9km", full.names = TRUE),
  data = map(filename, read_csv, col_names = c("yyyymm", "temp")),
  coords = map(filename, ~ str_split_fixed(., "_", 4)),
  lat = map_dbl(coords, ~ as.numeric(nth(., 3))),
  lon = map_dbl(coords, ~ parse_number(nth(., 4)))
) %>%
  select(lat, lon, data)

sst <- sst %>%
  mutate(data = map(data, ~ mutate(., year = str_sub(yyyymm, 1, 4), month = str_sub(yyyymm, 5, 6))))

sst <- sst %>%
  mutate(monthly_means = map(data, ~ group_by(., month) %>% summarize(mean = mean(temp))),
         mmm = map_dbl(monthly_means, ~ max(.$mean)),
         sumvar = map_dbl(data, ~ filter(.,  month %in% c("07", "08", "09")) %>% 
                            summarize(var = var(temp)) %>% pull(var)))
```

```{r, eval = FALSE}
summary(sst$mmm)
dft <- sst %>%
  distinct(source_lat = lat, source_lon = lon, mmm, sumvar) %>%
  right_join(df)

ggplot(dft, aes(x = sumvar, y = ed50, color = nursery)) + geom_point() +
  geom_smooth(method = "lm", se = FALSE)

modd <- lm(ed50 ~ sumvar * mmm + nursery, data = dft)
anova(modd)
lstrends(modd, var = "mmm", specs = "nursery")
#plot(modd)

augment(modd) %>%
  ggplot(aes(x = mmm,  y = ed50, color = nursery, size = std.error)) + 
  #geom_point(aes(size = `(weights)`)) +
  geom_point() +
  geom_line(aes(y = .fitted))
```

```{r, eval = FALSE}
#  5  km sst
ggplot(df, aes(x = as.numeric(MMM_5km), y = ed50)) + geom_point() +
  geom_smooth(method = "lm")

mod <- lm(ed50 ~ nursery, weights = 1/std.error^2, data = df)
anova(mod)

hi <- augment(mod) %>%
  mutate(adj = mean(ed50) + .resid) %>%
  left_join(df) %>%
  mutate(MMM_5km = as.numeric(MMM_5km))

mod <- lm(adj ~ MMM_5km, weights = 1/std.error^2, data = hi)
augment(mod) %>%
  ggplot(aes(x = MMM_5km, y = adj)) + geom_point() +
  geom_line(aes(y = .fitted))
```



```{r, eval = FALSE}
# Mean difference between two of the same geno at same nurs, two diff genos at same nurs, and two diff genos at diff nurs

df2 <- df %>% 
  group_by(nursery, geno) %>%
  mutate(rep = row_number())


mod <- lm(ed50 ~ nursery + geno/rep, data = df2)
anova(mod)


df2 %>% distinct(rep)
unique(df2$rep)



# Average within-replicate difference
df2 %>%
  filter(n() > 1) %>%
  arrange(nursery, geno)

bb <- df2 %>%
  select(nursery, geno, ed50) %>%
  group_by(nursery, geno) %>%
  filter(n() > 1) %>%
  nest(data = ed50) %>%
  mutate(dist = map(data, ~c(dist(.))))

bb %>% unnest(dist) %>%
  filter(dist < 1) %>%
  pull(dist) %>%
  mean(.)
  
# Average within-nursery difference
cc <- df2 %>%
  group_by(nursery) %>%
  select(nursery, ed50) %>%
  nest(data = ed50) %>%
  mutate(dist = map(data, ~c(dist(.))))

cc %>% unnest(dist) %>%
  pull(dist) %>%
  mean(.)


# Average difference
dd <- df2 %>%
  select(nursery, ed50)
mean(dist(dd$ed50))
```

