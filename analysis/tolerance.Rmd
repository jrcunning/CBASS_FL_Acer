---
title: "Thermal tolerance analysis"
output:
  html_document:
    code_folding: hide
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(readxl)
library(janitor)
library(parzer)
library(broom)
library(lsmeans)
library(drc)
library(tidyverse)
library(ggthemes)
library(multcompView)
```

This document analyzes the ED50 values (thermal tolerance metrics) derived for each individual coral genotype. Data filtering, dose-response curve fitting, and calculation of ED50 values for each coral can be found [here](tidy_PAM.html), and raw data from each CBASS run can be found here: [Mote](Mote_Acer.html), [FWC](FWC_Acer.html), [RRT](RRT_Acer.html), [CRF](CRF_Acer.html), [UM](UM_Acer.html), and [Kelsey's corals at NSU](KJS_Acer.html).


```{r import_data}
# Import cleaned datasets from each nursery
clean_data_files <- list.files(path = "data/processed", 
                               pattern = "*_clean.csv", 
                               full.names = TRUE)
clean_data <- clean_data_files %>% map_dfr(read_csv)

# Import genotype metadata
gmd <- read_csv("data/genotype_metadata_raw.csv") %>%
  mutate(nursery = tolower(nursery),
         across(everything(), str_squish),
         across(ends_with("lat"), ~signif(parse_lat(.), 6)),             # parse latitude
         across(ends_with("lon"), ~signif(parse_lon(.), 6))) %>%        # parse longitude
  mutate(ugeno = gsub(" ", "", ugeno)) %>%
  select(nursery, name = geno, source_lat, source_lon, MMM_5km)

# Import names key
gkey <- read_csv("data/genotype_name_key.csv") %>%
  mutate(alt0 = geno) %>%
  pivot_longer(starts_with("alt"), names_to = "alt", values_to = "name") %>%
  drop_na() %>%
  select(geno, name)

# Combine cleaned data with genotype metadata
df <- clean_data %>%
  rename(name = geno) %>%
  left_join(gkey) %>%
  select(nursery, geno, name, max_temp, fvfm, date) %>%
  left_join(gmd) %>%
  # Order nurseries from south to north
  mutate(nursery = factor(nursery, levels = c("mote", "fwc", "rrt", "crf", "um", "nsu"))) %>%
  select(nursery, name, geno, date, max_temp, fvfm, source_lat, source_lon, MMM_5km)

# Define dose-response curves using same constraints
ll3 <- function(data) {
  drm(fvfm ~ max_temp, data = data, 
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))}

# Fit model to each coral, get parameters, fitted values, and residuals
mods <- df %>%
  nest(data = c(max_temp, fvfm)) %>%
  # Fit the model to each coral
  mutate(ll3 = map(data, ll3)) %>%
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy),
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract parameter values from model fits
res <- mods %>%
  unnest(pars) %>%
  pivot_wider(names_from = term, 
              values_from = c(estimate, std.error, statistic, p.value)) %>%
  clean_names() %>%
  select(!where(is.list), -curve)

# Filter to analyze only CBASS runs from Coral Reef II in August and October
res <- res %>%
  filter(date %in% c("2020-08", "2020-10"))
```

# Do different genotypes have different thermal tolerance?

```{r test_geno_effect, eval = FALSE, include = FALSE}
# Fit single curve without genotype as a factor
mod_nogeno <- drm(fvfm ~ max_temp, data = df, 
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))
# Fit curves separately for each genotype
mod_geno <- drm(fvfm ~ max_temp, curveid = geno, data = df,
                fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(120, 0.72, 40),
      lowerl = c(10, 0.55, 30))
# Compare model fit with vs. without genotype as factor
anova(mod_nogeno, mod_geno)

## Genotype is highly significant
```

# What is the range in thermal tolerance across all genotypes?

```{r ed50_histograms}
# Basic histogram
ggplot(res, aes(x = estimate_ed50)) + 
  geom_histogram(binwidth = 0.1) +
  labs(x = "ED50 Tolerance (°C)", y = "Number of genotypes",
       title = "Histogram of ED50 values for all corals") +
  theme_few()

# Histogram colored by nursery with density plot
hist1 <- res %>%
  mutate(nursery = factor(nursery, levels = c("fwc", "um", "mote", "crf", "nsu", "rrt"))) %>%
  ggplot(aes(x = estimate_ed50)) + 
  geom_histogram(aes(fill = nursery), binwidth = 0.1, alpha = 0.4) +
  geom_density(aes(y = ..count.. * 0.1)) +
  theme_few() +
  theme(legend.position = c(0.15, 0.65), legend.key.size = unit(0.25, "cm")) +
  labs(x = "ED50 (°C)", y = "Count", title = expression(V[P]))
hist1

# Remove nursery effect
mod <- lm(estimate_ed50 ~ nursery, data = res)
res.adj <- augment(mod, data = res) %>%
  mutate(ed50_adj = mean(res$estimate_ed50) + .resid)

# Is adjusted distribution normal?
shapiro.test(res.adj$ed50_adj)

# Get mean and sd from adjusted distribution
meanadj <- mean(res.adj$ed50_adj)
sdadj <- sd(res.adj$ed50_adj)

hist2 <- ggplot(res.adj, aes(x = ed50_adj)) + 
  geom_histogram(aes(y = ..count../sum(..count..)), binwidth = 0.1, alpha = 0.4) +
  stat_function(fun = ~ dnorm(.x, meanadj, sdadj) * 0.1) +
  geom_vline(aes(xintercept = meanadj)) +
  geom_segment(aes(x = meanadj, xend = meanadj + sdadj, 
                   y = dnorm(meanadj + sdadj, meanadj, sdadj) * 0.1,
                   yend = dnorm(meanadj + sdadj, meanadj, sdadj) * 0.1),
               arrow = arrow(length = unit(0.2,"cm"), ends = "both"), lwd = 0.1) +
  xlim(qnorm(c(0.00001, 0.99999), meanadj, sdadj)) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  annotate("text", x = meanadj - 0.1, y = 0.125, adj = 1,
           label = paste0("mean = ", round(meanadj, 2))) +
  annotate("text", x = meanadj + sdadj + 0.1, 
           y = dnorm(meanadj + sdadj, meanadj, sdadj) * 0.1, 
           adj = 0, label = paste0("s.d. = ", round(sdadj, 2))) +
  theme_few() +
  labs(x = "ED50 (°C) adjusted", y = "Percentage", title = expression(V[P] - V[E]))
hist2

# Combine histograms into multi-panel figure
fig3 <- cowplot::plot_grid(
  hist1 + xlim(qnorm(c(0.00001, 0.99999), meanadj, sdadj)), 
  hist2, labels = "AUTO")

ggsave("output/fig3.png", width = 172, height = 75, units = "mm")
```

# Does thermal tolerance vary across nurseries?

```{r nursery_effects}
# Test for equal variance across nurseries
car::leveneTest(estimate_ed50 ~ nursery, data = res)
bartlett.test(estimate_ed50 ~ nursery, data = res)
## Unequal variance among nurseries -- cannot use ANOVA

# Get mean and sd by nursery for plotting
nurs.stats <- res %>%
  group_by(nursery) %>%
  summarise(mean = mean(estimate_ed50), sd = sd(estimate_ed50)) %>%
  ungroup() #%>%
  #mutate(group = factor(group))

# Use pairwise wilcox to test for differences in ED50 among nurseries
test <- pairwise.wilcox.test(res$estimate_ed50, res$nursery, p.adjust.method = "BH")
pvals <- tibble(reshape2::melt(test$p.value)) %>% drop_na() %>%
  mutate(Var1 = factor(Var1, levels = levels(fct_reorder(nurs.stats$nursery, nurs.stats$mean)))) %>%
  arrange(Var1)
stats <- setNames(pull(pvals[,3]), paste(pvals$Var1, pvals$Var2, sep = "-")) %>% multcompLetters()
lett <- enframe(stats$monospacedLetters, name = "nursery", value = "group")
nurs.stats <- left_join(nurs.stats, lett)
  
# Variance explained by nursery
tidy(aov(estimate_ed50 ~ nursery, data = res)) %>%
  mutate(pct.var = sumsq / sum(sumsq))

# Raincloud plot
source("https://raw.githubusercontent.com/datavizpyr/data/master/half_flat_violinplot.R")
nurs.fig <- ggplot(res, aes(x = nursery, y = estimate_ed50, fill = nursery, group = nursery)) +
  geom_hline(aes(yintercept = mean(estimate_ed50)), lty = 2, col = "gray") +
  geom_flat_violin(position = position_nudge(x = 0.2, y = 0), 
                   adjust = 1, width = 2, alpha = 0.7, lwd = 0) +
  geom_boxplot(position = position_nudge(x = 0.2, y = 0), width = 0.1,
               outlier.shape = NA, alpha = 1, lwd = 0.25) +
  geom_point(aes(color = nursery), alpha = 0.7,
             position = position_jitter(width = 0.075)) +
  geom_point(data = nurs.stats, aes(x = nursery, y = mean), inherit.aes = FALSE,
             position = position_nudge(x = 0, y = 0), size = 2, pch = 5) +
  geom_errorbar(data = nurs.stats, inherit.aes = FALSE, width = 0, lwd = 0.25,
                aes(x = nursery, y = mean, ymin = mean - sd, ymax = mean + sd),
                position = position_nudge(x = 0, y = 0)) +
  geom_text(data = nurs.stats, aes(y = 37.5, label = group), size = 2) +
  coord_flip() +
  scale_size(range = c(0.5, 3)) +
  scale_shape_manual(values = c(21, 22, 23, 24, 25)) +
  theme_few() +
  theme(legend.position = "none") +
  labs(y = "ED50 (°C)", x = "Nursery")
nurs.fig

ggsave("output/fig4.png", width = 120, height = 100, units = "mm")
```

# How does ED50 vary for the same genotype grown at different nurseries?
```{r}
# Get ED50s (adjusted for nursery effect) for genotypes present at multiple nurseries
multi.adj <- res.adj %>%
  # Filter genotypes present at more than one nursery
  group_by(geno) %>%
  filter(n_distinct(nursery) > 1) %>%
  # If genotype run more than once at a nursery, use mean ed50 within nursery
  group_by(geno, nursery) %>%
  summarize(ed50_adj = mean(ed50_adj)) %>%
  ungroup() %>%
  # Reorder genotypes based on mean ed50 across nurseries
  group_by(geno) %>%
  summarize(geno_mean_ed50 = mean(ed50_adj)) %>%
  right_join(multi.adj) %>%
  mutate(geno = fct_reorder(geno, geno_mean_ed50))

# Plot ED50adj by genotype
ggplot(multi.adj, aes(x = geno, y = ed50_adj, color = nursery, shape = nursery, group = geno)) + 
  geom_point(size = 2, alpha = 0.75) + 
  geom_point(aes(y = geno_mean_ed50), pch = 1, color = "black", stroke = 0.25)+
  stat_summary(fun.data = mean_se, geom = "errorbar", color = "black", lwd = 0.25, width = 0.25) +
  theme_few() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  labs(x = "Genotype", y = "Adjusted ED50 (°C)") +
  ylim(35, 37.7)
  
# Test for equal variance across genotypes
car::leveneTest(ed50_adj ~ geno, data = multi.adj)    # p = 0.019 => cannot use classic ANOVA

# Test for differences among genotypes with Welch's ANOVA
(welch <- oneway.test(ed50_adj ~ geno, data = multi.adj, var.equal = FALSE))
## Significant effect of genotype. Interpretation: ED50 value has a strong genetic component, and thermal tolerance phenotypes for a genet are reproducible even when genet moved to new environment.

# Estimate variance explained by genotype
omega.squared <- function(WelchF, df, N) df * (WelchF - 1) / (df * (WelchF - 1) + N)
omega.squared(WelchF = welch$statistic[[1]], df = welch$parameter[[1]], N = nrow(multi.adj))
## Genotype explains 49% of variance in ED50 measured across nurseries. Residual variance may be due to genotype by environment interactions (e.g., differential acclimatization of genotypes to different nursery environments), or CBASS run variability & measurement error.
```

# Is thermal tolerance related to source colony latitude and longitude?
```{r, eval = FALSE, fig.width = 10}
mod <- lm(ed50_adj ~ source_lat + source_lon, data = res.adj)
anova(mod)

lat.plot <- ggplot(res.adj, aes(x = source_lat, y = ed50_adj)) +
  geom_point(size = 0.75) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_few() +
  labs(x = "Latitude", y = "Adjusted ED50 (°C)")

lon.plot <- ggplot(res.adj, aes(x = source_lon, y = ed50_adj)) +
  geom_point(size = 0.75) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_few() +
  labs(x = "Longitude", y = NULL)
```

# Is thermal tolerance related to source colony temperature regime?
```{r, eval = TRUE}
# Import 9km SST data
sst9 <- tibble(
  filename = list.files("data/sst_9km", full.names = TRUE),
  data = map(filename, read_csv, col_names = c("yyyymm", "temp")),
  coords = map(filename, ~ str_split_fixed(basename(.), "_", 4)),
  lat = map_dbl(coords, ~ as.numeric(nth(., 3))),
  lon = map_dbl(coords, ~ parse_number(nth(., 4)))
) %>%
  select(lat, lon, data)

sst9 <- sst9 %>%
  mutate(data = map(data, ~ mutate(., year = str_sub(yyyymm, 1, 4), month = str_sub(yyyymm, 5, 6)))) %>%
  mutate(monthly_means = map(data, ~ group_by(., month) %>% summarize(mean = mean(temp))),
         mmm_9km = map_dbl(monthly_means, ~ max(.$mean)),
         sumvar = map_dbl(data, ~ filter(.,  month %in% c("07", "08", "09")) %>% 
                            summarize(var = var(temp)) %>% pull(var)))

# Join with results and sample metadata
dft <- sst9 %>%
  distinct(source_lat = lat, source_lon = lon, mmm_9km, sumvar) %>%
  right_join(res.adj) %>%
  mutate(mmm_5km = as.numeric(mmm_5km))

# Test effect of MMM from 9km data
mod9km <- lm(ed50_adj ~ mmm_9km, data = dft)
anova(mod9km)

# Test effect of MMM from 5km data
mod5km <- lm(ed50_adj ~ mmm_5km, data = dft)
anova(mod5km)

# Plots
mmm9.plot <- ggplot(dft, aes(x = mmm_9km, y = ed50_adj)) +
  geom_point(size = 0.75) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_few() +
  labs(x = "MMM (9km)", y = NULL)

mmm5.plot <- ggplot(dft, aes(x = mmm_5km, y = ed50_adj)) +
  geom_point(size = 0.75) +
  geom_smooth(method = "lm", se = FALSE) +
  theme_few() +
  labs(x = "MMM (5km)", y = NULL)
```

# Plot (lack of) relationship between ED50 and lat/lon/mmm
```{r}
cowplot::plot_grid(lat.plot, lon.plot, mmm9.plot, mmm5.plot, nrow = 1,
                   rel_widths = c(1.07,1,1,1))
```
