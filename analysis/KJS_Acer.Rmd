---
title: "KJS/NSU *A. cervicornis* CBASS run"
subtitle: "R/V *Coral Reef II*, August 20-21, 2020"
output: html_document
---


```{r setup}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

```{r}
library(janitor)
library(lubridate)
library(scales)
library(readxl)
library(ggthemes)
library(drc)
library(broom)
library(tidyverse)
```

# CBASS temperature logs

## Import CBASS log files
```{r}
b1log <- read_csv("data/raw/20200820_KJSNSU_Acer/Log_Files/B1_LOG_0821.TXT")

b1log <- b1log %>%
  filter(PrintDate != "PrintDate") %>%
  mutate(date = as_date(Date, format = "%Y_%B_%d")) %>%
  unite(time, Th, Tm, Ts, sep = ":") %>%
  unite(dttm, date, time) %>%
  mutate(dttm = ymd_hms(dttm),
         hm = format(dttm, "%H:%M")) %>%
  select(dttm, hm, T1SP, TempT1, T2SP, TempT2, T3SP, TempT3, T4SP, TempT4) %>%
  pivot_longer(starts_with("T"), names_to = "key", values_to = "temp") %>%
  filter(temp > 0, temp < 50) %>%
  mutate(tank = str_extract(key, "T[0-9]"),
         tank = paste0("B1", tank),
         key = case_when(grepl("SP", key) ~ str_sub(key, 3, 4),
                         TRUE ~ str_sub(key, 1, 4))) %>%
  pivot_wider(names_from = key, values_from = temp)

b2log <- read_csv("data/raw/20200820_KJSNSU_Acer/Log_Files/B2_LOG_0821.TXT")

b2log <- b2log %>%
  filter(PrintDate != "PrintDate") %>%
  mutate(date = as_date(Date, format = "%Y_%B_%d")) %>%
  unite(time, Th, Tm, Ts, sep = ":") %>%
  unite(dttm, date, time) %>%
  mutate(dttm = ymd_hms(dttm),
         hm = format(dttm, "%H:%M")) %>%
  select(dttm, hm, T1SP, TempT1, T2SP, TempT2, T3SP, TempT3, T4SP, TempT4) %>%
  pivot_longer(starts_with("T"), names_to = "key", values_to = "temp") %>%
  filter(temp > 0, temp < 50) %>%
  mutate(tank = str_extract(key, "T[0-9]"),
         tank = paste0("B2", tank),
         key = case_when(grepl("SP", key) ~ str_sub(key, 3, 4),
                         TRUE ~ str_sub(key, 1, 4))) %>%
  pivot_wider(names_from = key, values_from = temp)

log <- bind_rows(b1log, b2log) %>%
  mutate(tank = factor(tank),
         SP = as.numeric(SP),
         Temp = as.numeric(Temp))
```

## Import CBASS set points (used for settings file)
```{r}
sp <- read_xlsx("data/raw/20200820_KJSNSU_Acer/Temp_Profiles/CRII_ACERV_2020.xlsx") %>%
  mutate(Time = format(Time, "%H:%M")) %>%
  filter(Time >= "13:00", Time <= "22:00") %>%
  crossing(date = as_date(c("2020-08-20", "2020-08-21"))) %>%
  mutate(dttm = ymd_hm(paste(date, Time))) %>%
  select(dttm, matches("B")) %>%
  pivot_longer(-dttm, names_to = "tank", values_to = "Temp") %>%
  arrange(dttm)
```

## Plot CBASS temperature profiles with set points
```{r, fig.width = 10}
ggplot(mapping = aes(x = dttm, y = Temp, group = tank)) +
  geom_line(data = filter(log, hm > "12:50", hm < "21:50"),
            aes(color = tank), lwd = 0.2) +
  geom_step(data = sp, lwd = 0.2) +
  facet_wrap(~date(dttm), scales = "free") +
  scale_y_continuous(breaks = 30:37) +
  scale_x_datetime(breaks = "hours", labels = label_date("%H:%M")) +
  theme_hc() +
  theme(legend.position = "none") +
  labs(x = "Time of day", y = "Temperature (Â°C)")
```

# Initial data filtering and QC
```{r}
df <- read_csv("data/raw/20200820_KJSNSU_Acer/PAM/KJS_pamdata_tidy.csv")

df <- df %>%
  mutate(nursery = "kjs",
         geno = paste0("kjs", Genotype)) %>%
  select(nursery, geno, f, fm, fvfm, max_temp = Final_Temp) %>%
  drop_na(fvfm)

# df %>%
#   filter(max_temp <= 33) %>%
#   summarise(across(fvfm, list(mean, sd), na.rm= T))
# 
# 0.641 +  (2*0.0529)
# 
# df %>%
#   filter(max_temp >= 36) %>%
#   summarise(across(f, list(mean, sd), na.rm= T))
# 177 - (2*74.4)

# df %>%
#    filter(max_temp >= 36) %>%
#    mutate(mahal_dist = tidy_mahalanobis(f, fm, fvfmraw)) %>%
#    ggplot(aes(x = f,  y = fvfmraw)) + geom_point(aes(color = mahal_dist > 5))
# 
# devtools::install_github("JoeyStanley/joeyr")
# library(joeyr)
# 
# df <- df %>%
#   filter(max_temp >=)
#   mutate(mahal_dist = tidy_mahalanobis(max_temp, f, fm, fvfmraw))
# 
# ggplot(df, aes(x = max_temp, y = fvfmraw)) +
#   geom_point(aes(color = mahal_dist > 18)) +
#   facet_wrap(~geno)

df <- df %>%
  # Save raw fvfm data in new column
  mutate(fvfmraw = fvfm) %>%          
  # Identify problematic data points
  mutate(problem = case_when(
    fvfm > 0.746 ~ "abnormally high",
    max_temp >= 36 & fvfm >= 0.3 & f <= 120 ~ "abnormally high w/ low Ft",
    TRUE ~ "none")) %>%
  mutate(fvfm = case_when(
    problem == "abnormally high" ~ NA_real_,    # Change abnormally high values to NA
    problem == "abnormally high w/ low Ft" ~ 0,
    problem == "none" ~ fvfm))

df %>% count(problem)
```

# Initial model fitting and outlier detection
```{r model}
# Define function to fit 3-parameter LL model to data and return NULL if fitting error
ll3 <- function(data) {
  drm(fvfm ~ max_temp, data = data, 
      fct = LL.3(names = c("hill", "max", "ED50")),
      upperl = c(100, 0.75, 40),
      lowerl = c(20, 0.50, 30))}
tryll3 <- possibly(ll3, otherwise = NULL)

# Fit model to each coral, get parameters, fitted values, and residuals
initmods <- df %>%
  nest(data = c(max_temp, f, fm, fvfmraw, problem, fvfm)) %>%
  # Fit the model to each coral
  mutate(ll3 = map(data, tryll3)) %>%
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy),
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values from model fits
ed50 <- initmods %>% 
  select(nursery, geno, pars) %>%
  unnest(pars) %>%
  filter(term == "ED50")

# Collect raw data, fitted values, and diagnostics
vals <- initmods %>%
  select(nursery, geno, pred) %>%
  unnest(pred) %>%
  full_join(ed50) %>%
  full_join(df) %>%
  rename(ed50 = estimate)

# vals <- vals %>%
#    filter(max_temp >= 35) %>%
#    drop_na(fvfm) %>%
#    mutate(mahal_dist = tidy_mahalanobis(f, fvfmraw, .cooksd)) %>%
#    right_join(vals)
# 
# ggplot(vals, aes(x = max_temp, y = fvfmraw)) +
#   geom_point(aes(color = mahal_dist > 20)) +
#   facet_wrap(~geno)

# Identify problematic data points based on cook's distance and residuals
dff <- vals %>%
  group_by(nursery, geno) %>%
  mutate(resid.thresh = 2*sd(.resid)) %>%  # Calculate residual threshold as 2 standard deviations
  mutate(cooksd.thresh = 4/n()) %>%   # Calculate cook's distance threshold as 4/n
  mutate(max_to_remove = floor(n() * 0.25)) %>%
  ungroup() %>%
  mutate(problem = case_when(.cooksd > cooksd.thresh & .resid > 0 ~ "high cook's distance",
                             .resid > resid.thresh ~ "high residual", 
                             TRUE ~ problem)) %>%
  group_by(nursery, geno, outlier = problem %in% c("high cook's distance", "high residual")) %>%
  mutate(n.outliers = n(),
         rank.out = order(.cooksd)) %>%
  ungroup() %>%
  mutate(fvfm = case_when(outlier & rank.out <= max_to_remove ~ NA_real_, 
                          TRUE ~ fvfm)) 


# Refit models without problematic points
fmods <- dff %>%
  select(nursery, geno, max_temp, f, fm, fvfmraw, problem, fvfm) %>%
  nest(data = c(max_temp, f, fm, fvfmraw, fvfm, problem)) %>%
  # Fit the model to each coral
  mutate(ll3 = map(data, tryll3)) %>%
  # Get model parameters and fitted values/residuals
  mutate(pars = map(ll3, tidy),
         pred = map2(ll3, data, ~augment(.x, drop_na(.y, fvfm))))

# Extract ed50 parameter values from model fits
fed50 <- fmods %>% 
  select(nursery, geno, pars) %>%
  unnest(pars) %>%
  filter(term == "ED50")

# Collect raw data, fitted values, and ed50 estimates
fvals <- fmods %>%
  select(nursery, geno, pred) %>%
  unnest(pred) %>%
  full_join(fed50) %>%
  full_join(select(dff, nursery, geno, max_temp, f, fm, fvfmraw, problem, fvfm)) %>%
  rename(ed50 = estimate)
```

```{r plot, fig.width = 10, fig.height = 10}
# Define function to plot raw data, fitted values, and ed50 for each genotype
plotfits <- function(data) {
  ggplot(data = data, aes(x = max_temp)) +
    geom_point(pch = 4, size = 1.25,
               aes(y = fvfmraw, color = factor(problem, levels = c("none", "abnormally high", 
                                              "abnormally high w/ low Ft", 
                                              "high residual", "high cook's distance")))) +
    geom_point(aes(y = fvfm), pch = 1, size = 2) +
    geom_line(data = drop_na(data, .fitted),
              aes(y = .fitted)) +
    geom_vline(data = distinct(data, nursery, geno, ed50), 
               aes(xintercept = ed50), 
               lwd = 0.2, lty = 2) +
    geom_text(data = distinct(data, nursery, geno, ed50),
              aes(x = ed50, y = 0.05, label = round(ed50, 2)), 
              hjust = 1, nudge_x = -0.2, size = 3) +
    facet_wrap(~ nursery + geno, drop = TRUE) +
    scale_color_manual(name = "problem", drop = FALSE,
                       values = c("black", "red", "orange", "blue", "turquoise"))
}

# Plot fits
plotfits(data = fvals)
```

# Save processed data to file
```{r save}
# Write tidy data to file
fvals %>%
  select(nursery, geno, max_temp, fvfm) %>%
  drop_na() %>%
  write_csv("data/processed/KJS_fvfm_clean.csv")
```

